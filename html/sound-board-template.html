<!-- Copyright 2021, University of Colorado Boulder -->

<!Doctype html>
<html lang="en-us">

{{=it.buildMessage}}

<head>
  <meta charset="UTF-8">
  <title>PhET Soundboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
          integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
          integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
          crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
          integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
          crossorigin="anonymous"></script>

  <script>

    // create a Web Audio context
    let audioContext = null;
    if ( window.AudioContext ) {
      audioContext = new window.AudioContext();
    }
    else if ( window.webkitAudioContext ) {
      audioContext = new window.webkitAudioContext();
    }
    else {

      // The browser doesn't support creating an audio context, create an empty object.  Failures will occur the first time
      // any code tries to do anything with the audio context.
      audioContext = {};
      console.error( 'error: this browser does not support Web Audio' );
    }

    // Map.<string,AudioBuffer> - map of file paths to decoded audio buffers, used to cache decoded audio data
    const filePathToDecodedAudioBufferMap = new Map();

    // function to play a previously decoded audio buffer
    const playAudioBuffer = audioBuffer => {
      const bufferSource = audioContext.createBufferSource();
      bufferSource.buffer = audioBuffer;
      bufferSource.connect( audioContext.destination );
      bufferSource.start();
    };

    // function to play a sound file, will used cached data if possible or will initiate decode if not
    const playSound = soundUrl => {
      const audioBuffer = filePathToDecodedAudioBufferMap.get( soundUrl );
      if ( audioBuffer ) {

        // This file has already been decoded, so just play it.
        playAudioBuffer( audioBuffer );
      }
      else {

        // This is the first time this file has been played, so it needs to be decoded and then played.
        window.fetch( soundUrl )
          .then( response => response.arrayBuffer() )
          .then( arrayBuffer => audioContext.decodeAudioData( arrayBuffer ) )
          .then( audioBuffer => {
            filePathToDecodedAudioBufferMap.set( soundUrl, audioBuffer );
            playAudioBuffer( audioBuffer );
          } )
          .catch( error => {
            console.log( 'unable to play file ' + soundUrl + ', error = ' + error );
          } );
      }
    }

  </script>

</head>

<body>

  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <h1 class="mt-5">PhET Soundboard</h1>
        <p class="lead">A place where sound designers can try out the sounds associated with various sims individually.</p>
      </div>
    </div>
  </div>

  <div class="container">
    <div className="accordion" id="accordionExample">

      <!-- Each repo that uses sounds will be listed on a collapsible card with the sounds in the collapsible region -->
      {{~it.repoSoundInfoArray :value}}
      <div class="card">
        <div class="card-header" id="{{=value.cardHeaderID}}">
          <h5 class="mb-0">
            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#{{=value.collapseID}}"
                    aria-expanded="false" aria-controls="#{{=value.collapseID}}">
              {{=value.repoName}}
            </button>
          </h5>
        </div>

        <div id="{{=value.collapseID}}" class="collapse" aria-labelledby="{{=value.cardHeaderID}}"
             data-parent="#accordionExample">
          <div class="card-body">
            {{~value.individualSoundsInfoArray :value2:index2}}
            <button class="btn btn-primary col-lg-3 mt-1" title="{{=value2.buttonTitle}}" onClick="playSound( '{{=value2.soundFileFullPath}}' )">
              {{=value2.buttonLabel}}
            </button>
            {{~}}
          </div>
        </div>
      </div>
      {{~}}
    </div>
  </div>

</body>
</html>
